datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum SessionStatus {
  PENDING
  AGREED
}

enum ModuleStatus {
  COMPLETED
  INPROGRESS
}

enum RequestType {
  FRIEND
  SESSIONCREATED
  SESSIONACCEPTED
  SESSIONREJECTED
}

model User {
  aiSuggestionSkills     String[]
  id                     String       @id @default(uuid())
  name                   String       @unique
  password               String
  imageUrl               String?
  email                  String       @unique
  bio                    String?
  completedSessionsCount Int          @default(0)
  knownSkills            Skill[]      @relation("knownSkills")
  skillsToLearn          Skill[]      @relation("skillsToLearn")
  chats                  Chat[]       @relation("userChats")
  sessions               Session[]    @relation("userSessions")
  messagesSent           Message[]    @relation("sender")
  messagesReceived       Message[]    @relation("receiver")
  sentRequests           Request[]    @relation("sentRequests")
  receivedRequests       Request[]    @relation("receivedRequests")
  matchesInitiated       Match[]      @relation("MatchInitiator")
  matchesReceived        Match[]      @relation("otherUser")
  friends                Friendship[] @relation("UserFriends")
  friendOf               Friendship[] @relation("UserFriendsInverse")
}

model Friendship {
  id      String @id @default(uuid())
  user1   User   @relation("UserFriends", fields: [user1Id], references: [id])
  user1Id String
  user2   User   @relation("UserFriendsInverse", fields: [user2Id], references: [id])
  user2Id String

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
}

model Request {
  id        String      @id @default(uuid())
  type      RequestType
  from      User        @relation("sentRequests", fields: [fromId], references: [id])
  fromId    String
  to        User        @relation("receivedRequests", fields: [toId], references: [id])
  toId      String
  session   Session?    @relation("sessionRequest", fields: [sessionId], references: [id])
  sessionId String?
  status    String      @default("pending")

  @@index([fromId])
  @@index([toId])
  @@index([sessionId])
  @@index([type])
}

model Skill {
  id        String @id @default(uuid())
  title     String @unique
  knownBy   User[] @relation("knownSkills")
  learnedBy User[] @relation("skillsToLearn")
}

model Chat {
  id       String    @id @default(uuid())
  users    User[]    @relation("userChats")
  messages Message[]
}

model Message {
  id        String   @id @default(uuid())
  from      User     @relation("sender", fields: [fromId], references: [id])
  fromId    String
  to        User     @relation("receiver", fields: [toId], references: [id])
  toId      String
  chat      Chat     @relation(fields: [chatId], references: [id])
  chatId    String
  content   String
  createdAt DateTime @default(now())
  isSeen    Boolean  @default(false)

  @@index([chatId])
  @@index([fromId])
  @@index([toId])
  @@index([createdAt])
}

model Session {
  id          String        @id @default(uuid())
  title       String        @unique
  start       Int
  end         Int
  description String?
  status      SessionStatus @default(PENDING)
  date        DateTime
  color       String
  users       User[]        @relation("userSessions")
  request     Request[]     @relation("sessionRequest")
  meetingLink String?

  @@index([date])
  @@index([status])
}

model Match {
  id            String   @id @default(uuid())
  initiator     User     @relation("MatchInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  initiatorId   String
  other         User     @relation("otherUser", fields: [otherId], references: [id], onDelete: Cascade)
  otherId       String
  compatibility Int
  aiExplanation String
  keyBenefits   String[]
  plan          Plan?
  createdAt     DateTime @default(now())

  @@unique([initiatorId, otherId])
  @@index([initiatorId])
  @@index([otherId])
  @@index([createdAt])
}

model Plan {
  id      String   @id @default(uuid())
  modules Module[]
  matchId String   @unique
  match   Match    @relation(fields: [matchId], references: [id])
}

model Module {
  id         String       @id @default(uuid())
  title      String
  status     ModuleStatus @default(INPROGRESS)
  objectives String[]
  activities String[]
  timeline   Int
  resources  Resource[]
  planId     String
  plan       Plan         @relation(fields: [planId], references: [id])

  @@index([planId])
  @@index([status])
}

model Resource {
  id          String  @id @default(uuid())
  moduleId    String
  module      Module  @relation(fields: [moduleId], references: [id])
  title       String
  link        String
  description String?

  @@index([moduleId])
}
